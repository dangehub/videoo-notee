var g=typeof browser<"u",y=typeof chrome<"u"&&!g,s=g?browser:chrome;var v={async get(t){return s.storage.local.get(t)},async set(t){return s.storage.local.set(t)},async remove(t){return s.storage.local.remove(t)},async clear(){return s.storage.local.clear()}},T={async download(t){return new Promise((r,o)=>{s.downloads.download(t,e=>{s.runtime.lastError?o(new Error(s.runtime.lastError.message)):r(e)})})}},w={async query(t){return s.tabs.query(t)},async create(t){return s.tabs.create(t)},async sendMessage(t,r){return s.tabs.sendMessage(t,r)},async getCurrent(){return s.tabs.getCurrent()}},h={getURL(t){return s.runtime.getURL(t)},sendMessage(t){return s.runtime.sendMessage(t)},onMessage:s.runtime.onMessage,get lastError(){return s.runtime.lastError}},U={async open(t){return s.sidePanel?s.sidePanel.open(t):w.create({url:h.getURL("editor/index.html")})},async setOptions(t){if(s.sidePanel)return s.sidePanel.setOptions(t)}},$={async executeScript(t){return s.scripting.executeScript(t)}};var n={storage:v,downloads:T,tabs:w,runtime:h,sidePanel:U,scripting:$,isFirefox:g,isChrome:y,browserAPI:s};n.browserAPI.runtime.onInstalled.addListener(t=>{console.log("[Videoo Notee] \u6269\u5C55\u5DF2\u5B89\u88C5",t.reason),t.reason==="install"&&x()});async function x(){let t={ai:{apiEndpoint:"https://api.openai.com/v1",apiKey:"",model:"gpt-4"},export:{defaultFormat:"markdown",obsidianCompatible:!0,includeTimestamps:!0},editor:{defaultMode:"sidebar",autoSave:!0,autoSaveInterval:3e4},screenshot:{format:"png",quality:.92}};await n.storage.set({settings:t}),console.log("[Videoo Notee] \u9ED8\u8BA4\u8BBE\u7F6E\u5DF2\u521D\u59CB\u5316")}n.runtime.onMessage.addListener((t,r,o)=>(console.log("[Videoo Notee] \u6536\u5230\u6D88\u606F:",t.type),M(t,r).then(o).catch(e=>{console.error("[Videoo Notee] \u6D88\u606F\u5904\u7406\u9519\u8BEF:",e),o({error:e.message})}),!0));async function M(t,r){switch(t.type){case"GET_SETTINGS":return m();case"SAVE_SETTINGS":return N(t.data);case"OPEN_EDITOR":return A(t.data,r);case"SAVE_NOTE":return _(t.data);case"GET_NOTES":return I(t.data);case"EXPORT_NOTE":return P(t.data);case"CAPTURE_SCREENSHOT":return O(r.tab);case"SAVE_SCREENSHOT":return C(t.data,r);case"GET_CURRENT_VIDEO":return D();case"GET_SCREENSHOTS":return L(t.data);default:throw new Error(`\u672A\u77E5\u6D88\u606F\u7C7B\u578B: ${t.type}`)}}async function m(){return(await n.storage.get("settings")).settings||{}}async function N(t){return await n.storage.set({settings:t}),{success:!0}}async function A(t={},r=null){var i,a;let o=await m(),e=t.mode||((i=o.editor)==null?void 0:i.defaultMode)||"sidebar";if((t.videoUrl||t.videoTitle||t.timestamp!==void 0)&&await n.storage.set({currentVideo:{url:t.videoUrl||"",title:t.videoTitle||"",timestamp:t.timestamp||0,tabId:((a=r==null?void 0:r.tab)==null?void 0:a.id)||null,updatedAt:Date.now()}}),e==="sidebar")try{let[c]=await n.tabs.query({active:!0,currentWindow:!0});n.browserAPI.sidePanel?await n.browserAPI.sidePanel.open({tabId:c.id}):await n.tabs.create({url:n.runtime.getURL("editor/index.html")})}catch(c){console.error("[Videoo Notee] \u6253\u5F00\u4FA7\u8FB9\u680F\u5931\u8D25:",c),await n.tabs.create({url:n.runtime.getURL("editor/index.html")})}else await n.tabs.create({url:n.runtime.getURL("editor/index.html")});return{success:!0}}async function _(t){let o=(await n.storage.get("notes")).notes||{},e=t.id||`note_${Date.now()}`;return o[e]={...t,id:e,updatedAt:Date.now()},await n.storage.set({notes:o}),{success:!0,noteId:e}}async function I(t={}){let o=(await n.storage.get("notes")).notes||{},e=Object.values(o);return t.videoUrl&&(e=e.filter(i=>i.videoUrl===t.videoUrl)),e.sort((i,a)=>a.updatedAt-i.updatedAt),e}async function P(t){let{noteId:r,filename:o}=t,a=((await n.storage.get("notes")).notes||{})[r];if(!a)throw new Error("\u7B14\u8BB0\u4E0D\u5B58\u5728");let c=R(a),l=new Blob([c],{type:"text/markdown"}),u=URL.createObjectURL(l);return await n.downloads.download({url:u,filename:o||`${a.title||"note"}.md`,saveAs:!0}),{success:!0}}function R(t){var i;let o=((i=m().export)==null?void 0:i.obsidianCompatible)??!0,e=`# ${t.title||"\u89C6\u9891\u7B14\u8BB0"}

`;if(t.videoUrl&&(e+=`> \u89C6\u9891\u94FE\u63A5: ${t.videoUrl}

`),t.content&&(e+=t.content+`

`),t.entries&&t.entries.length>0){e+=`## \u7B14\u8BB0\u5185\u5BB9

`;for(let a of t.entries){if(a.timestamp!==void 0){let c=V(a.timestamp),l=t.videoUrl?`[${c}](${t.videoUrl}&t=${Math.floor(a.timestamp)})`:c;e+=`### ${l}

`}a.screenshot&&(e+=`![\u622A\u56FE](${a.screenshot})

`),a.text&&(e+=a.text+`

`)}}return e}function V(t){let r=Math.floor(t/3600),o=Math.floor(t%3600/60),e=Math.floor(t%60);return r>0?`${r}:${o.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`:`${o}:${e.toString().padStart(2,"0")}`}async function O(t){if(!t)throw new Error("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u6807\u7B7E\u9875");return await n.tabs.sendMessage(t.id,{type:"CAPTURE_VIDEO_FRAME"})}async function C(t,r){var f,p;let e=(await n.storage.get("screenshots")).screenshots||[],i=t.timestamp||0,a=(t.videoTitle||"screenshot").replace(/[<>:"/\\|?*]/g,"_").replace(/\s+/g,"_").slice(0,50),c=Math.floor(i/3600),l=Math.floor(i%3600/60),u=Math.floor(i%60),S=c>0?`${c}-${l.toString().padStart(2,"0")}-${u.toString().padStart(2,"0")}`:`${l}-${u.toString().padStart(2,"0")}`,E=`ss_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,b=`${a}_${S}.jpg`,d={id:E,filename:b,dataUrl:t.screenshot,timestamp:t.timestamp,videoUrl:t.videoUrl,videoTitle:t.videoTitle,tabId:((f=r==null?void 0:r.tab)==null?void 0:f.id)||null,createdAt:Date.now()};for(e.push(d);e.length>50;)e.shift();return await n.storage.set({screenshots:e}),await n.storage.set({currentVideo:{url:t.videoUrl||"",title:t.videoTitle||"",tabId:((p=r==null?void 0:r.tab)==null?void 0:p.id)||null,updatedAt:Date.now()}}),console.log("[Videoo Notee] \u622A\u56FE\u5DF2\u7F13\u5B58:",d.id),{success:!0,screenshotId:d.id,filename:d.filename}}async function L(t={}){let o=(await n.storage.get("screenshots")).screenshots||[];return t.videoUrl&&(o=o.filter(e=>e.videoUrl===t.videoUrl)),o.sort((e,i)=>i.createdAt-e.createdAt),o}async function D(){return(await n.storage.get("currentVideo")).currentVideo||null}console.log("[Videoo Notee] Service Worker \u5DF2\u542F\u52A8");
