var E=typeof browser<"u",G=typeof chrome<"u"&&!E,c=E?browser:chrome;var W={async get(e){return c.storage.local.get(e)},async set(e){return c.storage.local.set(e)},async remove(e){return c.storage.local.remove(e)},async clear(){return c.storage.local.clear()}},Y={async download(e){return new Promise((t,n)=>{c.downloads.download(e,i=>{c.runtime.lastError?n(new Error(c.runtime.lastError.message)):t(i)})})}},B={async query(e){return c.tabs.query(e)},async create(e){return c.tabs.create(e)},async sendMessage(e,t){return c.tabs.sendMessage(e,t)},async getCurrent(){return c.tabs.getCurrent()}},C={getURL(e){return c.runtime.getURL(e)},sendMessage(e){return c.runtime.sendMessage(e)},onMessage:c.runtime.onMessage,get lastError(){return c.runtime.lastError}},J={async open(e){return c.sidePanel?c.sidePanel.open(e):B.create({url:C.getURL("editor/index.html")})},async setOptions(e){if(c.sidePanel)return c.sidePanel.setOptions(e)}},X={async executeScript(e){return c.scripting.executeScript(e)}};var l={storage:W,downloads:Y,tabs:B,runtime:C,sidePanel:J,scripting:X,isFirefox:E,isChrome:G,browserAPI:c};function p(e,t=!1){if(typeof e!="number"||isNaN(e))return"0:00";e=Math.max(0,Math.floor(e));let n=Math.floor(e/3600),i=Math.floor(e%3600/60),a=e%60;return n>0||t?`${n}:${i.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`:`${i}:${a.toString().padStart(2,"0")}`}var m={YOUTUBE:"youtube",BILIBILI:"bilibili",LOCAL:"local",UNKNOWN:"unknown"};function Q(e){if(!e)return m.UNKNOWN;if(e.startsWith("file://"))return m.LOCAL;try{let n=new URL(e).hostname.toLowerCase();if(n.includes("youtube.com")||n.includes("youtu.be"))return m.YOUTUBE;if(n.includes("bilibili.com")||n.includes("b23.tv"))return m.BILIBILI}catch{}return m.UNKNOWN}function M(e,t){if(!e)return"";let n=Q(e),i=Math.floor(t);switch(n){case m.YOUTUBE:return V(e,i);case m.BILIBILI:return Z(e,i);case m.LOCAL:return`${e}#t=${i}`;default:try{let a=new URL(e);return a.searchParams.set("t",i.toString()),a.toString()}catch{return e}}}function V(e,t){try{let n=new URL(e);return n.hostname==="youtu.be"?`https://www.youtube.com/watch?v=${n.pathname.slice(1)}&t=${t}`:(n.searchParams.set("t",t.toString()),n.toString())}catch{return e}}function Z(e,t){try{let n=new URL(e);return n.searchParams.set("t",t.toString()),n.toString()}catch{return e}}var ee={obsidianCompatible:!0,includeTimestamps:!0,includeScreenshots:!0,imageFormat:"embed",useWikilinks:!1};function A(e,t={}){let n={...ee,...t},i=[];if(i.push(`# ${P(e.title||"\u89C6\u9891\u7B14\u8BB0")}`),i.push(""),e.videoUrl&&i.push(`> **\u89C6\u9891\u94FE\u63A5**: ${e.videoUrl}`),e.videoTitle&&i.push(`> **\u89C6\u9891\u6807\u9898**: ${P(e.videoTitle)}`),e.createdAt&&i.push(`> **\u521B\u5EFA\u65F6\u95F4**: ${N(e.createdAt)}`),i.push(""),e.description&&(i.push(e.description),i.push("")),e.entries&&e.entries.length>0){i.push("---"),i.push("");for(let a of e.entries)i.push(...te(a,e.videoUrl,n)),i.push("")}return e.aiSummary&&(i.push("---"),i.push(""),i.push("## AI \u603B\u7ED3"),i.push(""),i.push(e.aiSummary),i.push("")),e.subtitles&&n.includeSubtitles&&(i.push("---"),i.push(""),i.push("## \u5B57\u5E55"),i.push(""),i.push("```"),i.push(e.subtitles),i.push("```")),i.join(`
`)}function te(e,t,n){let i=[];if(n.includeTimestamps&&e.timestamp!==void 0){let a=p(e.timestamp);if(t){let o=M(t,e.timestamp);i.push(`### [${a}](${o})`)}else i.push(`### ${a}`);i.push("")}if(n.includeScreenshots&&e.screenshot){let a=ne(e.screenshot,e.screenshotPath,n);i.push(a),i.push("")}return e.text&&(i.push(e.text),i.push("")),e.tags&&e.tags.length>0&&(n.obsidianCompatible?i.push(e.tags.map(a=>`#${a}`).join(" ")):i.push(`*Tags: ${e.tags.join(", ")}*`),i.push("")),i}function ne(e,t,n){return n.imageFormat==="base64"&&e.startsWith("data:")?`![\u622A\u56FE](${e})`:t?n.useWikilinks&&n.obsidianCompatible?`![[${t.split(/[/\\]/).pop()}]]`:`![\u622A\u56FE](${t})`:`![\u622A\u56FE](${e})`}function P(e){return e?e.replace(/([*_`\[\]#])/g,"\\$1"):""}function N(e){return new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function O(e){let t=e.title||e.videoTitle||"note";t=t.replace(/[<>:"/\\|?*]/g,"_"),t=t.slice(0,100);let n=N(Date.now()).replace(/[/:]/g,"-").replace(/\s/g,"_");return`${t}_${n}.md`}var ie={apiEndpoint:"https://api.openai.com/v1",apiKey:"",model:"gpt-4",maxTokens:2e3,temperature:.7},f=class{constructor(t={}){this.config={...ie,...t}}async loadConfig(){var n;let t=await l.storage.get("settings");return(n=t.settings)!=null&&n.ai&&(this.config={...this.config,...t.settings.ai}),this.config}async saveConfig(t){let i=(await l.storage.get("settings")).settings||{};i.ai={...i.ai,...t},await l.storage.set({settings:i}),this.config={...this.config,...t}}isConfigured(){return!!this.config.apiKey}async summarizeSubtitles(t,n={}){let{language:i="zh-CN",style:a="concise",maxLength:o=500}=n,d=this.buildSummaryPrompt(t,{language:i,style:a,maxLength:o});return this.chat(d)}async suggestNotes(t,n){let i=`\u57FA\u4E8E\u4EE5\u4E0B\u89C6\u9891\u5B57\u5E55\u5185\u5BB9\uFF0C\u4E3A\u65F6\u95F4\u70B9 ${this.formatTime(n)} \u9644\u8FD1\u7684\u5185\u5BB9\u751F\u6210\u7B14\u8BB0\u5EFA\u8BAE\uFF1A

${t}

\u8BF7\u63D0\u4F9B\uFF1A
1. \u5173\u952E\u8981\u70B9
2. \u53EF\u80FD\u7684\u7B14\u8BB0\u5185\u5BB9
3. \u76F8\u5173\u95EE\u9898`;return this.chat(i)}async chat(t,n=null){var d,x,S,k;if(!this.isConfigured())throw new Error("\u8BF7\u5148\u914D\u7F6E AI API Key");let i=[];n&&i.push({role:"system",content:n}),i.push({role:"user",content:t});let a=await fetch(`${this.config.apiEndpoint}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify({model:this.config.model,messages:i,max_tokens:this.config.maxTokens,temperature:this.config.temperature})});if(!a.ok){let H=await a.json().catch(()=>({}));throw new Error(((d=H.error)==null?void 0:d.message)||`API \u8BF7\u6C42\u5931\u8D25: ${a.status}`)}return((k=(S=(x=(await a.json()).choices)==null?void 0:x[0])==null?void 0:S.message)==null?void 0:k.content)||""}buildSummaryPrompt(t,n){let{language:i,style:a,maxLength:o}=n,d="";switch(a){case"detailed":d="\u8BF7\u63D0\u4F9B\u8BE6\u7EC6\u7684\u603B\u7ED3\uFF0C\u5305\u62EC\u6240\u6709\u91CD\u8981\u7EC6\u8282\u548C\u8BBA\u70B9\u3002";break;case"bullet":d="\u8BF7\u4F7F\u7528\u8981\u70B9\u5217\u8868\u7684\u5F62\u5F0F\u8FDB\u884C\u603B\u7ED3\u3002";break;default:d="\u8BF7\u63D0\u4F9B\u7B80\u6D01\u7684\u603B\u7ED3\uFF0C\u7A81\u51FA\u6838\u5FC3\u5185\u5BB9\u3002"}return`\u8BF7\u603B\u7ED3\u4EE5\u4E0B\u89C6\u9891\u5B57\u5E55\u5185\u5BB9\u3002

\u8981\u6C42\uFF1A
- \u4F7F\u7528 ${i==="zh-CN"?"\u7B80\u4F53\u4E2D\u6587":i} \u8F93\u51FA
- ${d}
- \u603B\u7ED3\u957F\u5EA6\u4E0D\u8D85\u8FC7 ${o} \u5B57

\u5B57\u5E55\u5185\u5BB9\uFF1A
${t}`}formatTime(t){let n=Math.floor(t/3600),i=Math.floor(t%3600/60),a=Math.floor(t%60);return n>0?`${n}:${i.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`:`${i}:${a.toString().padStart(2,"0")}`}},Se=new f;var s=null,h=[],w="edit",y=null,r={sidebar:null,notesTree:null,noteTitle:null,editorTextarea:null,editorPane:null,liveEditorPane:null,liveEditor:null,previewPane:null,markdownPreview:null,screenshotsList:null,subtitlePanel:null,subtitleContent:null,videoTitleDisplay:null,videoTimeDisplay:null,settingsModal:null};async function re(){r.sidebar=document.getElementById("sidebar"),r.notesTree=document.getElementById("notes-tree"),r.noteTitle=document.getElementById("note-title"),r.editorTextarea=document.getElementById("editor-textarea"),r.editorPane=document.getElementById("editor-pane"),r.liveEditorPane=document.getElementById("live-editor-pane"),r.liveEditor=document.getElementById("live-editor"),r.previewPane=document.getElementById("preview-pane"),r.markdownPreview=document.getElementById("markdown-preview"),r.screenshotsList=document.getElementById("screenshots-list"),r.subtitlePanel=document.getElementById("subtitle-panel"),r.subtitleContent=document.getElementById("subtitle-content"),r.videoTitleDisplay=document.getElementById("video-title-display"),r.videoTimeDisplay=document.getElementById("video-time-display"),r.settingsModal=document.getElementById("settings-modal"),y=new f,await y.loadConfig(),ae(),await D();let t=new URLSearchParams(location.search).get("note");t?_(t):U(),location.hash==="#settings"&&I(),l.runtime.onMessage.addListener(Ee)}function ae(){var e,t,n;document.getElementById("btn-toggle-sidebar").addEventListener("click",se),document.getElementById("btn-new-note").addEventListener("click",U),document.getElementById("search-input").addEventListener("input",he),document.getElementById("btn-mode-edit").addEventListener("click",()=>b("edit")),document.getElementById("btn-mode-live").addEventListener("click",()=>b("live")),document.getElementById("btn-mode-preview").addEventListener("click",()=>b("preview")),document.getElementById("btn-screenshot").addEventListener("click",R),document.getElementById("btn-timestamp").addEventListener("click",j),document.getElementById("btn-subtitle").addEventListener("click",pe),document.getElementById("btn-ai-summary").addEventListener("click",z),(e=document.getElementById("btn-open-mode"))==null||e.addEventListener("click",ue),document.getElementById("btn-export").addEventListener("click",ce),document.getElementById("btn-save").addEventListener("click",$),document.getElementById("btn-close-subtitle").addEventListener("click",()=>{r.subtitlePanel.classList.add("hidden")}),document.getElementById("btn-copy-subtitle").addEventListener("click",ge),document.getElementById("btn-ai-summarize").addEventListener("click",fe),(t=document.getElementById("btn-settings"))==null||t.addEventListener("click",I),document.getElementById("btn-close-settings").addEventListener("click",F),document.getElementById("btn-save-settings").addEventListener("click",be),r.editorTextarea.addEventListener("input",T(()=>{v(),w==="live"&&q()},500)),r.noteTitle.addEventListener("input",T(v,3e3)),(n=r.liveEditor)==null||n.addEventListener("input",T(()=>{K(),v()},500)),document.addEventListener("keydown",ye),r.noteTitle.addEventListener("change",()=>{s&&(s.title=r.noteTitle.value)})}function se(){r.sidebar.classList.toggle("collapsed")}async function U(){let e=null,t=[];try{e=await l.runtime.sendMessage({type:"GET_CURRENT_VIDEO"}),t=await l.runtime.sendMessage({type:"GET_SCREENSHOTS",data:e!=null&&e.url?{videoUrl:e.url}:{}})}catch(n){console.log("\u83B7\u53D6\u89C6\u9891\u4E0A\u4E0B\u6587\u5931\u8D25:",n)}s={id:null,title:(e==null?void 0:e.title)||"",content:"",videoUrl:(e==null?void 0:e.url)||"",videoTitle:(e==null?void 0:e.title)||"",entries:[],screenshots:t.map(n=>({dataUrl:n.dataUrl,timestamp:n.timestamp,addedAt:n.createdAt})),createdAt:Date.now(),updatedAt:Date.now()},r.noteTitle.value=s.title,r.editorTextarea.value="",e!=null&&e.url?(r.videoTitleDisplay.textContent=e.title||"\u89C6\u9891\u7B14\u8BB0",r.videoTimeDisplay.textContent=e.timestamp?p(e.timestamp):"--:--"):(r.videoTitleDisplay.textContent="\u672A\u5173\u8054\u89C6\u9891",r.videoTimeDisplay.textContent="--:--"),L(),document.querySelectorAll(".note-tree-item").forEach(n=>n.classList.remove("active"))}async function D(){try{h=await l.runtime.sendMessage({type:"GET_NOTES",data:{}}),oe()}catch(e){console.error("\u52A0\u8F7D\u7B14\u8BB0\u5931\u8D25:",e)}}function oe(){if(!h||h.length===0){r.notesTree.innerHTML='<p style="padding: 16px; color: rgba(255,255,255,0.4); text-align: center;">\u6682\u65E0\u7B14\u8BB0</p>';return}r.notesTree.innerHTML=h.map(e=>`
    <div class="note-tree-item ${(s==null?void 0:s.id)===e.id?"active":""}" data-id="${e.id}">
      <span class="note-icon">\u{1F4DD}</span>
      <span class="note-name">${Te(e.title||"\u672A\u547D\u540D\u7B14\u8BB0")}</span>
    </div>
  `).join(""),document.querySelectorAll(".note-tree-item").forEach(e=>{e.addEventListener("click",()=>_(e.dataset.id))})}async function _(e){let t=h.find(n=>n.id===e);t&&(s={...t},r.noteTitle.value=t.title||"",r.editorTextarea.value=t.content||"",r.videoTitleDisplay.textContent=t.videoTitle||"\u672A\u5173\u8054\u89C6\u9891",document.querySelectorAll(".note-tree-item").forEach(n=>{n.classList.toggle("active",n.dataset.id===e)}),L())}async function $(){if(s){s.title=r.noteTitle.value||"\u672A\u547D\u540D\u7B14\u8BB0",s.content=r.editorTextarea.value,s.updatedAt=Date.now();try{let e=await l.runtime.sendMessage({type:"SAVE_NOTE",data:s});e.noteId&&!s.id&&(s.id=e.noteId),await D(),u("\u4FDD\u5B58\u6210\u529F")}catch(e){console.error("\u4FDD\u5B58\u5931\u8D25:",e),u("\u4FDD\u5B58\u5931\u8D25")}}}async function v(){s&&(r.noteTitle.value||r.editorTextarea.value)&&await $()}async function ce(){var e;if(s){s.title=r.noteTitle.value,s.content=r.editorTextarea.value;try{let t=await l.runtime.sendMessage({type:"GET_SETTINGS"}),n=A(s,{obsidianCompatible:((e=t.export)==null?void 0:e.obsidianCompatible)??!0}),i=new Blob([n],{type:"text/markdown"}),a=URL.createObjectURL(i),o=O(s),d=document.createElement("a");d.href=a,d.download=o,d.click(),URL.revokeObjectURL(a),u("\u5BFC\u51FA\u6210\u529F")}catch(t){console.error("\u5BFC\u51FA\u5931\u8D25:",t),u("\u5BFC\u51FA\u5931\u8D25")}}}async function R(){try{let[e]=await l.tabs.query({active:!0,currentWindow:!0});if(!e){u("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u6807\u7B7E\u9875");return}let t=await l.tabs.sendMessage(e.id,{type:"CAPTURE_VIDEO_FRAME"});if(t.error){u(t.error);return}let n={dataUrl:t.dataUrl,timestamp:t.timestamp,addedAt:Date.now()};s.screenshots||(s.screenshots=[]),s.screenshots.push(n);let i=p(t.timestamp),a=`
![\u622A\u56FE ${i}](${t.dataUrl})
`;g(a),L(),u(`\u5DF2\u63D2\u5165\u622A\u56FE ${i}`)}catch(e){console.error("\u622A\u56FE\u5931\u8D25:",e),u("\u622A\u56FE\u5931\u8D25\uFF0C\u8BF7\u786E\u4FDD\u5728\u89C6\u9891\u9875\u9762")}}function L(){var e;if(!((e=s==null?void 0:s.screenshots)!=null&&e.length)){r.screenshotsList.innerHTML="";return}r.screenshotsList.innerHTML=s.screenshots.map((t,n)=>{var a;return`
        <img src="${t.dataUrl||`file:///${(a=t.filePath)==null?void 0:a.replace(/\\/g,"/")}`}" 
             class="screenshot-thumb" 
             data-index="${n}"
             title="${p(t.timestamp)} - ${t.filename||""}"
             alt="\u622A\u56FE ${n+1}"
             onerror="this.style.display='none'">
        `}).join(""),document.querySelectorAll(".screenshot-thumb").forEach(t=>{t.addEventListener("click",()=>{let n=parseInt(t.dataset.index),i=s.screenshots[n],a=i.filename||i.dataUrl,o=`
![\u622A\u56FE ${p(i.timestamp)}](${a})
`;g(o)})})}async function j(){try{let[e]=await l.tabs.query({active:!0,currentWindow:!0});if(e){let t=await l.tabs.sendMessage(e.id,{type:"GET_VIDEO_INFO"});if((t==null?void 0:t.currentTime)!==void 0){let n=p(t.currentTime),i=t.url?`[${n}](${t.url}&t=${Math.floor(t.currentTime)})`:n;g(`${i} `);return}}g("[00:00] ")}catch{g("[00:00] ")}}function g(e){if(w==="live"&&r.liveEditor){let t=window.getSelection();if(t.rangeCount>0){let n=t.getRangeAt(0);n.deleteContents();let i=e.match(/!\[(.*?)\]\((.*?)\)/);if(i){let a=document.createElement("img");a.src=i[2],a.alt=i[1],n.insertNode(a)}else n.insertNode(document.createTextNode(e))}K()}else{let t=r.editorTextarea,n=t.selectionStart,i=t.selectionEnd,a=t.value;t.value=a.substring(0,n)+e+a.substring(i),t.selectionStart=t.selectionEnd=n+e.length,t.focus()}}function b(e){var t,n,i,a;w=e,document.querySelectorAll(".mode-btn").forEach(o=>o.classList.remove("active")),(t=document.getElementById(`btn-mode-${e}`))==null||t.classList.add("active"),(n=r.editorPane)==null||n.classList.toggle("hidden",e!=="edit"),(i=r.liveEditorPane)==null||i.classList.toggle("hidden",e!=="live"),(a=r.previewPane)==null||a.classList.toggle("hidden",e!=="preview"),e==="live"?q():e==="preview"&&me()}function q(){if(!r.liveEditor)return;let e=r.editorTextarea.value;r.liveEditor.innerHTML=le(e)}function K(){if(!r.liveEditor)return;let e=r.liveEditor.innerHTML,t=de(e);r.editorTextarea.value=t,s&&(s.content=t)}function le(e){if(!e)return"";let t={};return s!=null&&s.screenshots&&s.screenshots.forEach(i=>{t[i.filename]=i.dataUrl}),e.replace(/!\[(.*?)\]\((.*?)\)/g,(i,a,o)=>`<img src="${t[o]||o}" alt="${a}" data-original-src="${o}">`).replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" class="timestamp-link">$1</a>').replace(/\[\[(.*?)\]\]/g,'<span class="wikilink">[[$1]]</span>').replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/^- (.*$)/gm,"<div>\u2022 $1</div>").replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>")}function de(e){let t=document.createElement("div");t.innerHTML=e;function n(i){if(i.nodeType===Node.TEXT_NODE)return i.textContent;if(i.nodeType!==Node.ELEMENT_NODE)return"";let a=i.tagName.toLowerCase(),o=Array.from(i.childNodes).map(n).join("");switch(a){case"img":let d=i.dataset.originalSrc||i.src;return`![${i.alt||"\u622A\u56FE"}](${d})`;case"a":return`[${o}](${i.href})`;case"strong":case"b":return`**${o}**`;case"em":case"i":return`*${o}*`;case"h1":return`# ${o}
`;case"h2":return`## ${o}
`;case"h3":return`### ${o}
`;case"br":return`
`;case"div":case"p":return o+`
`;case"span":return i.classList.contains("wikilink"),o;default:return o}}return n(t).trim()}function ue(){l.runtime.sendMessage({type:"OPEN_EDITOR",data:{mode:"standalone"}})}function me(){let t=r.editorTextarea.value.replace(/^### (.*$)/gm,"<h3>$1</h3>").replace(/^## (.*$)/gm,"<h2>$1</h2>").replace(/^# (.*$)/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/!\[(.*?)\]\((.*?)\)/g,'<img src="$2" alt="$1">').replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank">$1</a>').replace(/\[\[(.*?)\]\]/g,'<span class="wikilink">$1</span>').replace(/^- (.*$)/gm,"<li>$1</li>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>");r.markdownPreview.innerHTML=`<p>${t}</p>`}function pe(){r.subtitlePanel.classList.toggle("hidden")}function ge(){let e=r.subtitleContent.textContent;navigator.clipboard.writeText(e).then(()=>{u("\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F")})}async function fe(){let e=r.subtitleContent.textContent;if(!e){u("\u6682\u65E0\u5B57\u5E55\u5185\u5BB9");return}await z(e)}async function z(e){if(!y.isConfigured()){u("\u8BF7\u5148\u914D\u7F6E AI API Key"),I();return}let t=e||r.editorTextarea.value;if(!t){u("\u6682\u65E0\u5185\u5BB9\u53EF\u603B\u7ED3");return}u("\u6B63\u5728\u751F\u6210 AI \u603B\u7ED3...");try{let n=await y.summarizeSubtitles(t,{language:"zh-CN",style:"bullet"});g(`

## AI \u603B\u7ED3

${n}
`),u("AI \u603B\u7ED3\u5DF2\u63D2\u5165")}catch(n){console.error("AI \u603B\u7ED3\u5931\u8D25:",n),u("AI \u603B\u7ED3\u5931\u8D25: "+n.message)}}function he(e){let t=e.target.value.toLowerCase();document.querySelectorAll(".note-tree-item").forEach(n=>{let i=n.querySelector(".note-name").textContent.toLowerCase();n.style.display=i.includes(t)?"":"none"})}function ye(e){e.ctrlKey&&e.key==="s"&&(e.preventDefault(),$()),e.altKey&&e.key==="s"&&(e.preventDefault(),R()),e.altKey&&e.key==="t"&&(e.preventDefault(),j())}function Ee(e){switch(e.type){case"SUBTITLE_LOADED":r.subtitlePanel.classList.remove("hidden"),r.subtitleContent.textContent=e.data.text;break;case"VIDEO_INFO_UPDATE":s&&(s.videoUrl=e.data.url,s.videoTitle=e.data.title,r.videoTitleDisplay.textContent=e.data.title||"\u672A\u77E5\u89C6\u9891");break}}function I(){r.settingsModal.classList.remove("hidden"),ve()}function F(){r.settingsModal.classList.add("hidden")}async function ve(){var t,n,i,a;let e=await l.runtime.sendMessage({type:"GET_SETTINGS"});document.getElementById("setting-api-endpoint").value=((t=e.ai)==null?void 0:t.apiEndpoint)||"",document.getElementById("setting-api-key").value=((n=e.ai)==null?void 0:n.apiKey)||"",document.getElementById("setting-model").value=((i=e.ai)==null?void 0:i.model)||"gpt-4",document.getElementById("setting-obsidian-compat").checked=((a=e.export)==null?void 0:a.obsidianCompatible)??!0}async function be(){let e={ai:{apiEndpoint:document.getElementById("setting-api-endpoint").value,apiKey:document.getElementById("setting-api-key").value,model:document.getElementById("setting-model").value},export:{obsidianCompatible:document.getElementById("setting-obsidian-compat").checked}};await l.runtime.sendMessage({type:"SAVE_SETTINGS",data:e}),await y.saveConfig(e.ai),F(),u("\u8BBE\u7F6E\u5DF2\u4FDD\u5B58")}function u(e){let t=document.querySelector(".toast");t&&t.remove();let n=document.createElement("div");n.className="toast",n.style.cssText=`
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
  `,n.textContent=e,document.body.appendChild(n),setTimeout(()=>n.remove(),3e3)}function Te(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}function T(e,t){let n;return(...i)=>{clearTimeout(n),n=setTimeout(()=>e.apply(this,i),t)}}re();
