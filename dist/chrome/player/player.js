async function E(t,e={}){let{format:n="jpeg",quality:r=.85}=e;if(!t||!(t instanceof HTMLVideoElement))throw new Error("\u65E0\u6548\u7684\u89C6\u9891\u5143\u7D20");if(t.readyState<2)throw new Error("\u89C6\u9891\u5C1A\u672A\u52A0\u8F7D");let i=t.videoWidth,o=t.videoHeight,s=t.currentTime,l=document.createElement("canvas");l.width=i,l.height=o,l.getContext("2d").drawImage(t,0,0,i,o);let c=`image/${n}`,$=l.toDataURL(c,r),y=await new Promise(g=>{l.toBlob(g,c,r)});return{dataUrl:$,blob:y,width:i,height:o,timestamp:s,format:n}}function f(t,e=!1){if(typeof t!="number"||isNaN(t))return"0:00";t=Math.max(0,Math.floor(t));let n=Math.floor(t/3600),r=Math.floor(t%3600/60),i=t%60;return n>0||e?`${n}:${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${r}:${i.toString().padStart(2,"0")}`}var d={YOUTUBE:"youtube",BILIBILI:"bilibili",LOCAL:"local",UNKNOWN:"unknown"};function F(t){if(!t)return d.UNKNOWN;if(t.startsWith("file://"))return d.LOCAL;try{let n=new URL(t).hostname.toLowerCase();if(n.includes("youtube.com")||n.includes("youtu.be"))return d.YOUTUBE;if(n.includes("bilibili.com")||n.includes("b23.tv"))return d.BILIBILI}catch{}return d.UNKNOWN}function M(t,e){if(!t)return"";let n=F(t),r=Math.floor(e);switch(n){case d.YOUTUBE:return P(t,r);case d.BILIBILI:return W(t,r);case d.LOCAL:return`${t}#t=${r}`;default:try{let i=new URL(t);return i.searchParams.set("t",r.toString()),i.toString()}catch{return t}}}function P(t,e){try{let n=new URL(t);return n.hostname==="youtu.be"?`https://www.youtube.com/watch?v=${n.pathname.slice(1)}&t=${e}`:(n.searchParams.set("t",e.toString()),n.toString())}catch{return t}}function W(t,e){try{let n=new URL(t);return n.searchParams.set("t",e.toString()),n.toString()}catch{return t}}var V={obsidianCompatible:!0,includeTimestamps:!0,includeScreenshots:!0,imageFormat:"embed",useWikilinks:!1};function U(t,e={}){let n={...V,...e},r=[];if(r.push(`# ${B(t.title||"\u89C6\u9891\u7B14\u8BB0")}`),r.push(""),t.videoUrl&&r.push(`> **\u89C6\u9891\u94FE\u63A5**: ${t.videoUrl}`),t.videoTitle&&r.push(`> **\u89C6\u9891\u6807\u9898**: ${B(t.videoTitle)}`),t.createdAt&&r.push(`> **\u521B\u5EFA\u65F6\u95F4**: ${K(t.createdAt)}`),r.push(""),t.description&&(r.push(t.description),r.push("")),t.entries&&t.entries.length>0){r.push("---"),r.push("");for(let i of t.entries)r.push(..._(i,t.videoUrl,n)),r.push("")}return t.aiSummary&&(r.push("---"),r.push(""),r.push("## AI \u603B\u7ED3"),r.push(""),r.push(t.aiSummary),r.push("")),t.subtitles&&n.includeSubtitles&&(r.push("---"),r.push(""),r.push("## \u5B57\u5E55"),r.push(""),r.push("```"),r.push(t.subtitles),r.push("```")),r.join(`
`)}function _(t,e,n){let r=[];if(n.includeTimestamps&&t.timestamp!==void 0){let i=f(t.timestamp);if(e){let o=M(e,t.timestamp);r.push(`### [${i}](${o})`)}else r.push(`### ${i}`);r.push("")}if(n.includeScreenshots&&t.screenshot){let i=H(t.screenshot,t.screenshotPath,n);r.push(i),r.push("")}return t.text&&(r.push(t.text),r.push("")),t.tags&&t.tags.length>0&&(n.obsidianCompatible?r.push(t.tags.map(i=>`#${i}`).join(" ")):r.push(`*Tags: ${t.tags.join(", ")}*`),r.push("")),r}function H(t,e,n){return n.imageFormat==="base64"&&t.startsWith("data:")?`![\u622A\u56FE](${t})`:e?n.useWikilinks&&n.obsidianCompatible?`![[${e.split(/[/\\]/).pop()}]]`:`![\u622A\u56FE](${e})`:`![\u622A\u56FE](${t})`}function B(t){return t?t.replace(/([*_`\[\]#])/g,"\\$1"):""}function K(t){return new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}var w=class{constructor(e={}){this.options=e}async getAvailableSubtitles(){throw new Error("\u5B50\u7C7B\u5FC5\u987B\u5B9E\u73B0 getAvailableSubtitles \u65B9\u6CD5")}async getSubtitle(e){throw new Error("\u5B50\u7C7B\u5FC5\u987B\u5B9E\u73B0 getSubtitle \u65B9\u6CD5")}async getCurrentSubtitle(){throw new Error("\u5B50\u7C7B\u5FC5\u987B\u5B9E\u73B0 getCurrentSubtitle \u65B9\u6CD5")}parseToCommon(e){throw new Error("\u5B50\u7C7B\u5FC5\u987B\u5B9E\u73B0 parseToCommon \u65B9\u6CD5")}toPlainText(e,n={}){let{includeTimestamps:r=!1,separator:i=`
`}=n;return e.map(o=>r?`[${this.formatTime(o.start)}] ${o.text}`:o.text).join(i)}formatTime(e){let n=Math.floor(e/1e3),r=Math.floor(n/3600),i=Math.floor(n%3600/60),o=n%60;return r>0?`${r}:${i.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`:`${i}:${o.toString().padStart(2,"0")}`}},S=class{constructor(){this.providers=new Map}registerProvider(e,n){this.providers.set(e,n)}getProvider(e){return this.providers.get(e)||null}detectProvider(e){for(let[n,r]of this.providers)if(r.matchUrl&&r.matchUrl(e))return r;return null}},ct=new S;var v=class extends w{constructor(e={}){super(e),this.platform="local",this.loadedSubtitles=[]}matchUrl(e){return e.startsWith("file://")||e.startsWith("blob:")}async loadFromFile(e){let n=await this.readFile(e),r=this.detectFormat(e.name),i;switch(r){case"srt":i=this.parseSRT(n);break;case"vtt":i=this.parseVTT(n);break;default:throw new Error(`\u4E0D\u652F\u6301\u7684\u5B57\u5E55\u683C\u5F0F: ${r}`)}return this.loadedSubtitles=i,i}async getAvailableSubtitles(){return this.loadedSubtitles.length>0?[{id:"local",language:"unknown",label:"\u672C\u5730\u5B57\u5E55",isAuto:!1}]:[]}async getSubtitle(e){return this.loadedSubtitles}async getCurrentSubtitle(){return""}parseSRT(e){let n=[],r=e.trim().split(/\n\n+/);for(let i of r){let o=i.split(`
`);if(o.length<3)continue;let s=o[1].match(/(\d{2}):(\d{2}):(\d{2})[,.](\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})[,.](\d{3})/);if(!s)continue;let l=this.timeToMs(parseInt(s[1]),parseInt(s[2]),parseInt(s[3]),parseInt(s[4])),L=this.timeToMs(parseInt(s[5]),parseInt(s[6]),parseInt(s[7]),parseInt(s[8])),c=o.slice(2).join(`
`).trim();n.push({start:l,end:L,text:c})}return n}parseVTT(e){let n=[],i=e.replace(/^WEBVTT.*?\n\n/s,"").trim().split(/\n\n+/);for(let o of i){let s=o.split(`
`),l=0;for(let b=0;b<s.length;b++)if(s[b].includes("-->")){l=b;break}let c=s[l].match(/(\d{2}):?(\d{2}):(\d{2})\.(\d{3})\s*-->\s*(\d{2}):?(\d{2}):(\d{2})\.(\d{3})/);if(!c)continue;let $=this.timeToMs(parseInt(c[1]),parseInt(c[2]),parseInt(c[3]),parseInt(c[4])),y=this.timeToMs(parseInt(c[5]),parseInt(c[6]),parseInt(c[7]),parseInt(c[8])),g=s.slice(l+1).join(`
`).trim();g&&n.push({start:$,end:y,text:g})}return n}parseToCommon(e){return typeof e=="string"?e.trim().startsWith("WEBVTT")?this.parseVTT(e):this.parseSRT(e):e}timeToMs(e,n,r,i){return e*36e5+n*6e4+r*1e3+i}readFile(e){return new Promise((n,r)=>{let i=new FileReader;i.onload=()=>n(i.result),i.onerror=r,i.readAsText(e)})}detectFormat(e){var r;let n=(r=e.split(".").pop())==null?void 0:r.toLowerCase();return n==="srt"?"srt":n==="vtt"||n==="webvtt"?"vtt":"unknown"}};var p=null,A=null,T=[],h=[],a=document.getElementById("video-player"),m=document.getElementById("drop-overlay"),I=document.getElementById("file-input"),C=document.getElementById("subtitle-input"),x=document.getElementById("note-input"),O=document.getElementById("note-entries"),k=document.getElementById("subtitle-display");function Y(){A=new v,q()}function q(){m.addEventListener("dragover",z),m.addEventListener("dragleave",X),m.addEventListener("drop",G),m.addEventListener("click",()=>I.click()),I.addEventListener("change",J),C.addEventListener("change",Q),document.getElementById("btn-open-file").addEventListener("click",()=>I.click()),document.getElementById("btn-load-subtitle").addEventListener("click",()=>C.click()),document.getElementById("btn-screenshot").addEventListener("click",R),document.getElementById("btn-add-note").addEventListener("click",tt),document.getElementById("btn-export-note").addEventListener("click",et),a.addEventListener("timeupdate",Z),document.addEventListener("keydown",nt)}function z(t){t.preventDefault(),m.classList.add("dragging")}function X(t){t.preventDefault(),m.classList.remove("dragging")}function G(t){t.preventDefault(),m.classList.remove("dragging");let e=t.dataTransfer.files;if(e.length>0){let n=e[0];n.type.startsWith("video/")?N(n):(n.name.endsWith(".srt")||n.name.endsWith(".vtt"))&&j(n)}}function J(t){let e=t.target.files[0];e&&N(e)}async function Q(t){let e=t.target.files[0];e&&await j(e)}function N(t){p=t;let e=URL.createObjectURL(t);a.src=e,m.classList.add("hidden"),document.title=`${t.name} - Videoo Notee`,console.log("[Videoo Notee] \u5DF2\u52A0\u8F7D\u89C6\u9891:",t.name)}async function j(t){try{T=await A.loadFromFile(t),console.log("[Videoo Notee] \u5DF2\u52A0\u8F7D\u5B57\u5E55:",t.name,`\u5171 ${T.length} \u6761`),u(`\u5DF2\u52A0\u8F7D\u5B57\u5E55: ${t.name}`)}catch(e){console.error("\u52A0\u8F7D\u5B57\u5E55\u5931\u8D25:",e),u("\u52A0\u8F7D\u5B57\u5E55\u5931\u8D25: "+e.message)}}function Z(){if(T.length===0)return;let t=a.currentTime*1e3,e=T.find(n=>t>=n.start&&t<=n.end);e?(k.textContent=e.text,k.classList.remove("hidden")):k.classList.add("hidden")}async function R(){if(!a.src){u("\u8BF7\u5148\u52A0\u8F7D\u89C6\u9891");return}try{let t=await E(a),e={id:Date.now(),timestamp:t.timestamp,screenshot:t.dataUrl,text:x.value.trim()};h.push(e),x.value="",D(),u(`\u5DF2\u622A\u56FE ${f(t.timestamp)}`)}catch(t){console.error("\u622A\u56FE\u5931\u8D25:",t),u("\u622A\u56FE\u5931\u8D25: "+t.message)}}function tt(){let t=x.value.trim();if(!t){u("\u8BF7\u8F93\u5165\u7B14\u8BB0\u5185\u5BB9");return}let e={id:Date.now(),timestamp:a.currentTime||0,text:t};h.push(e),x.value="",D(),u("\u7B14\u8BB0\u5DF2\u6DFB\u52A0")}function D(){if(h.length===0){O.innerHTML='<p style="text-align: center; color: rgba(255,255,255,0.4); padding: 20px;">\u6682\u65E0\u7B14\u8BB0</p>';return}let t=[...h].sort((e,n)=>e.timestamp-n.timestamp);O.innerHTML=t.map(e=>`
    <div class="note-entry" data-id="${e.id}">
      <div class="note-entry-header">
        <span class="note-entry-time" data-time="${e.timestamp}">
          ${f(e.timestamp)}
        </span>
      </div>
      <div class="note-entry-content">
        ${e.screenshot?`<img src="${e.screenshot}" class="note-entry-screenshot" alt="\u622A\u56FE">`:""}
        ${e.text?`<div class="note-entry-text">${rt(e.text)}</div>`:""}
      </div>
    </div>
  `).join(""),document.querySelectorAll(".note-entry-time").forEach(e=>{e.addEventListener("click",()=>{let n=parseFloat(e.dataset.time);a.currentTime=n,a.play()})})}function et(){if(h.length===0){u("\u6682\u65E0\u7B14\u8BB0\u53EF\u5BFC\u51FA");return}let t={title:(p==null?void 0:p.name)||"\u672C\u5730\u89C6\u9891\u7B14\u8BB0",videoUrl:p?`file:///${p.name}`:"",entries:h.map(s=>({timestamp:s.timestamp,screenshot:s.screenshot,text:s.text})),createdAt:Date.now()},e=U(t),n=new Blob([e],{type:"text/markdown"}),r=URL.createObjectURL(n),i=`${t.title.replace(/\.[^.]+$/,"")}_\u7B14\u8BB0.md`,o=document.createElement("a");o.href=r,o.download=i,o.click(),URL.revokeObjectURL(r),u("\u5BFC\u51FA\u6210\u529F")}function nt(t){t.target.tagName==="TEXTAREA"||t.target.tagName==="INPUT"||(t.code==="Space"&&(t.preventDefault(),a.paused?a.play():a.pause()),t.altKey&&t.key==="s"&&(t.preventDefault(),R()),t.code==="ArrowLeft"&&(a.currentTime=Math.max(0,a.currentTime-5)),t.code==="ArrowRight"&&(a.currentTime=Math.min(a.duration,a.currentTime+5)))}function u(t){let e=document.querySelector(".toast");e&&e.remove();let n=document.createElement("div");n.className="toast",n.style.cssText=`
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    z-index: 10000;
  `,n.textContent=t,document.body.appendChild(n),setTimeout(()=>n.remove(),3e3)}function rt(t){let e=document.createElement("div");return e.textContent=t,e.innerHTML}Y();
